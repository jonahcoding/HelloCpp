# 一、C++内存管理

## 1.1 C++内存分区

### 1.1.1 C++内存划分

**五个区：栈、堆、自由存储区、全局/静态存储区、常量存储区。**

> 栈区：存放引用，函数内的普通局部变量、形参和函数返回值。
>
> 堆区：由程序员使用malloc()等函数申请，使用free()释放。
>
> 自由存储区：new申请的内存，使用delete释放。
>
> 全局/静态存储区：存放全局变量和静态变量，申请的内存在程序全部结束后释放。
>
> 常量存储区：（程序运行期间不能被改变的量，如：10，字符串常量"abc"，数组的名字等）

### 1.1.2 堆区与自由存储区的区别（重点）

> C++标准未做要求，但多数（几乎所有）编译器的new/delete以malloc/free为基础来实现。
>
> ​		堆是C语言和OS的术语，是OS维护的一块特殊内存，提供动态分配的功能。自由存储是C++中通过new和delete动态分配和释放对象的抽象概念，通过new申请的内存可称为自由存储区。所有的C++编译器使用堆来实现自由存储，可说new得到的对象在堆上，也在自由存储区上。通过重载new运算符，改用其它内存实现自由存储，此时自由存储区别于堆。
>
> **总结：**
>
> 1. **自由存储是C++中通过new和delete动态分配和释放对象的抽象概念。**
> 2. **堆是C语言和OS的术语，是OS维护的一块特殊内存。**
> 3. **new申请的内存区域在C++中称为自由存储区，由堆实现，可说new申请的内存在堆上。**
> 4. **堆与自由存储区非等价关系（可重载new改用其它方式实现自由存储区）**

## 1.2 malloc()

### 1.2.1 malloc()

malloc函数原型：

```c++
void * malloc(unsigned int size); 
```

- 分配的内存大小为size参数指定的字节数。
- 不对分配的内存进行初始化，内存中可以是任意值。

- 返回值：
  - 成功：返回一个万能指针（可转为任意类型），指向申请的内存的起始地址。
  - 失败：返回NULL。

使用示例：

```c++
//为字符串shinrin申请内存
char * pName;
pName = (char*)malloc(strlen("shinrin") + 1);//	+1：系统自动追加结束符'\0'
if(pName != NULL)
{ 
    strcpy(pName, "shinrin"); 
}
free(pName);

//为Person类申请内存
Person* person = (Person*)malloc(sizeof(Person));
if(person !== NULL)
{
    free(person);
}
```

### 1.2.2 扩展

**calloc()函数原型：**

```c++
void * calloc(unsigned int n,unsigned int size);
```

- 函数说明：申请n个大小为size的内存空间。
- 函数特点：对申请的内存进行初始化，初始值为0。
- 返回值：
  - 成功：返回一个存放指针的数组，数组元素指向申请的内存的起始地址。
  - 失败：返回NULL。

**realloc()函数原型：**

```c++
void * realloc(void *p,unsigned int size);
```

- 函数说明：将指针p所指向的已分配内存区的大小改为size。
- 参数要求：size必须大于原有内存大小。
- 函数详解：
  - 如果原有内存后的连续空间充足，只进行扩展即可。
  - 否则，申请新的内存空间，拷贝原有数据并释放旧内存。
- 返回值：
  - 成功：返回一个指针，指向新内存的起始地址。
  - 失败：返回NULL。

### 1.2.3 malloc()的缺点

1. 程序员必须确定对象的长度。
2. malloc()返回void *，C++不允许将void *赋值给其它类型的指针，必须使用强转。
3. malloc()可能申请内存失败，需要依据返回值进行判断。
4. **malloc()只为对象分配内存，不调用对象的构造方法（初始化）。**

##  1.3 new

### 1.3.1 new的使用

```c++
//手动申请内存，调用构造函数
Person *p = new Person;
//手动释放内存
delete p;
```
**new 表达式：**

1. **申请内存（new操作符，重载以改变内存分区）。**
2. **引发类的构造函数。**

new表达式无法重定义。

### 1.3.2 new与malloc()的区别（重点）

1. new是C++中的操作符，malloc()是C中的函数。
2. new不仅分配内存，而且调用类的构造函数，同理delete会调用类的析构函数；malloc()只分配内存，free()只释放内存。

补充资料：https://www.cnblogs.com/jiayouwyhit/p/3753909.html









